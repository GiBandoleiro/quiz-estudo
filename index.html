<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Perguntas (QUIZ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background': '#121212',
                        'card': '#1E1E1E',
                        'accent': '#00BFFF', // Neon Blue
                        'text-primary': '#E0E0E0',
                        'text-secondary': '#A0A0A0',
                        'success': '#10B981', // Green
                        'error': '#EF4444', // Red
                        'file-tag': '#3A3A3A',
                    },
                }
            }
        }
    </script>
    <style>
        /* Apply Inter font for body, Poppins for titles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
        }
        .title-font {
            font-family: 'Poppins', sans-serif;
            letter-spacing: 0.05em;
        }
        .card {
            background-color: #1E1E1E;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.6); /* Slightly stronger shadow */
            border: 1px solid #282828;
            transition: all 0.3s ease-in-out;
            border-radius: 16px;
        }
        .card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.8);
        }
        .btn-accent {
            background-color: #00BFFF;
            color: #121212;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-accent:hover:not(:disabled) {
            background-color: #0099CC;
            transform: translateY(-1px);
        }
        .btn-option {
            background-color: #282828;
            border: 1px solid #3A3A3A;
            transition: all 0.2s;
        }
        .btn-option:hover:not(:disabled) {
            background-color: #3A3A3A;
            transform: scale(1.01);
            border-color: #00BFFF;
        }
        .input-field {
            background-color: #282828;
            border: 1px solid #3A3A3A;
            color: #E0E0E0;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            border-color: #00BFFF;
            outline: none;
        }
        /* Custom range slider styling for dark theme */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #3A3A3A;
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
            border-radius: 4px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #00BFFF;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(0, 191, 255, 0.6);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #00BFFF;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(0, 191, 255, 0.6);
        }
        /* Style for the file tags */
        .file-tag {
            background-color: #3A3A3A;
            border: 1px solid #4A4A4A;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.85rem;
            color: #E0E0E0;
            display: inline-flex;
            align-items: center;
            margin-right: 8px;
            margin-bottom: 8px;
            transition: background-color 0.2s;
        }
        .file-tag-remove {
            cursor: pointer;
            margin-left: 8px;
            color: #A0A0A0;
            transition: color 0.2s;
        }
        .file-tag-remove:hover {
            color: #EF4444;
        }
        /* Style for a transient success message */
        .modal-success-card {
            background-color: #10B981; /* success color */
            color: #121212;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.6);
            animation: fadeInOut 2s forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
    </style>
</head>
<body class="bg-background text-text-primary min-h-screen p-4 flex justify-center items-start pt-28 md:pt-32">
 <div class="fixed top-0 left-0 right-0 z-50 w-full text-center py-4 bg-gray-800 shadow-lg text-white">  
        <p class="text-sm flex justify-center items-center gap-4">  
          Desenvolvido por Giovanni Fuentes Giannetti:    
          <a href="https://instagram.com/giovanni.fg" target="_blank" class="text-pink-400 hover:text-pink-300 flex items-center gap-1"> <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-5 h-5"> <path d="M12 2.2c3.2 0 3.6 0 4.9.1 1.2.1 1.9.3 2.3.5.6.2 1 .6 1.4 1.1.4.4.9 1 1.1 1.6.2.4.4 1.1.5 2.3.1 1.3.1 1.7.1 4.9s0 3.6-.1 4.9c-.1 1.2-.3 1.9-.5 2.3-.2.6-.6 1-1.1 1.4-.4.4-1 .9-1.6 1.1-.4.2-1.1.4-2.3.5-1.3.1-1.7.1-4.9.1s-3.6 0-4.9-.1c-1.2-.1-1.9-.3-2.3-.5-.6-.2-1-.6-1.4-1.1-.4-.4-.9-1-1.1-1.6-.2-.4-.4-1.1-.5-2.3C2.2 15.6 2.2 15.2 2.2 12s0-3.6.1-4.9c.1-1.2.3-1.9.5-2.3.2-.6.6-1 1.1-1.4.4-.4 1-.9 1.6-1.1.4-.2 1.1.4 2.3.5C8.4 2.2 8.8 2.2 12 2.2m0-2.2C8.7 0 8.3 0 7 .1 5.7.2 4.7.4 4 .7c-.9.4-1.7 1-2.4 1.7C.9 3.1.3 3.9 0 4.8c-.3.7-.5 1.7-.6 3C-.7 9 .7 9.3.7 12s0 3 .1 4.2c.1 1.3.3 2.3.6 3 .3.9.9 1.7 1.6 2.4.7.7 1.5 1.3 2.4 1.6.7.3 1.7.5 3 .6 1.2.1 1.6.1 4.9.1s3.6 0 4.9-.1c1.3-.1 2.3-.3 3-.6.9-.3 1.7-.9 2.4-1.6.7-.7 1.3-1.5 1.6-2.4.3-.7.5-1.7.6-3 .1-1.2.1-1.6.1-4.9s0-3.6-.1-4.9c-.1-1.3-.3-2.3-.6-3-.3-.9-.9-1.7-1.6-2.4C21.1 1.6 20.3 1 19.4.7c-.7-.3-1.7-.5-3-.6C15.6 0 15.2 0 12 0z"/> <path d="M12 5.8a6.2 6.2 0 1 0 0 12.4A6.2 6.2 0 0 0 12 5.8zm0 10.2a4 4 0 1 1 0-8.1 4 4 0 0 1 0 8.1zM18.4 4.6a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/>  
          </svg> @giovanni.fg </a>  
          <a href="https://linkedin.com/in/giovanni-fg" target="_blank" class="text-blue-400 hover:text-blue-300 flex items-center gap-1">  
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-5 h-5">  
              <path d="M4.98 3.5C4.98 5 3.9 6 2.5 6S0 5 0 3.5 1.12 1 2.5 1s2.48 1 2.48 2.5zM.5 8h4V24h-4V8zM8.5 8h3.8v2.2h.1c.5-.9 1.8-1.9 3.7-1.9 3.9 0 4.6 2.5 4.6 5.7V24h-4v-7.8c0-1.9 0-4.4-2.7-4.4-2.7 0-3.1 2.1-3.1 4.2V24h-4V8z"/>  
            </svg>  
            giovanni-fg  
          </a>  
        </p>  
    </div>

    <div id="app" class="w-full max-w-lg mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-extrabold text-accent mb-2 tracking-wider title-font">Gerador de Perguntas (QUIZ)</h1>
            <p id="current-score" class="text-lg text-text-secondary hidden"></p>
        </header>

        <div id="content" class="min-h-[400px] flex flex-col justify-center">
            </div>

        <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden" onclick="hideModal()">
            <div id="modal-card" class="card p-6 rounded-xl max-w-sm w-full" onclick="event.stopPropagation()">
                <div id="modal-content-container">
                    <p id="modal-text" class="text-center font-medium text-lg"></p>
                    <div id="progress-bar-container" class="mt-4 hidden">
                        <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div id="progress-bar" class="h-full bg-accent transition-all duration-500 ease-in-out" style="width: 0%"></div>
                        </div>
                        <p id="progress-text" class="text-center text-sm text-text-secondary mt-2">0%</p>
                    </div>
                </div>
                <button id="modal-close-btn" class="w-full mt-4 btn-accent py-2 rounded-lg font-bold hidden" onclick="hideModal()">
                    Fechar
                </button>
            </div>
        </div>
    </div>
    <script>
        // Global variables and constants
        const TEXT_MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        // Chave de API inserida conforme solicita√ß√£o
        const API_KEY = "AIzaSyA0LecQ2UW0nZvLTlnp-Utp4NHxVeIfvX8"; 
        const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL_NAME}:generateContent?key=${API_KEY}`;
        
        // Application State
        const state = {
            view: 'input', // 'input', 'options', 'quiz', 'review', 'end'
            previousView: 'input', // Para rastrear a tela anterior
            themeText: '',
            uploadedFiles: [], // Array de {name: string, content: string}
            numQuestions: 5,
            questions: [],
            currentQuestionIndex: 0,
            score: 0,
            quizModeActive: false,
            showReviewAnswers: false,
        };

        const appDiv = document.getElementById('app');
        const contentDiv = document.getElementById('content');
        const modalDiv = document.getElementById('modal');
        const modalText = document.getElementById('modal-text');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCard = document.getElementById('modal-card'); 

        // Progress Bar variables
        let progressInterval = null;
        let currentProgress = 0;
        let successTimeout = null; // Para o feedback de sucesso

        // --- Utility Functions ---
        /**
         * Simple exponential backoff for API calls.
         * @param {number} maxRetries Max number of retries.
         * @param {function} fn Function to execute.
         */
        async function withBackoff(maxRetries, fn) {
            for (let i = 0; i <= maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- Modal/Progress Functions ---
        function updateProgressBar(percentage) {
            const bar = document.getElementById('progress-bar');
            const text = document.getElementById('progress-text');
            currentProgress = Math.min(percentage, 100);
            if (bar && text) {
                bar.style.width = `${currentProgress}%`;
                text.textContent = `${currentProgress.toFixed(0)}%`;
            }
        }

        function startProgressSimulation() {
            stopProgressSimulation(); // Clear any existing interval
            currentProgress = 0;
            updateProgressBar(0);
            
            // Simulate processing time by slowly increasing progress
            progressInterval = setInterval(() => {
                if (currentProgress < 95) { // Stop just before 100% to wait for real API response
                    currentProgress += Math.random() * 2 + 1; 
                    updateProgressBar(currentProgress);
                }
            }, 500);
        }

        function stopProgressSimulation() {
            clearInterval(progressInterval);
            progressInterval = null;
        }

        /**
         * Displays the custom modal.
         * @param {string} message The text to display.
         * @param {boolean} showCloseButton Whether to show the close button.
         * @param {boolean} showProgress Whether to show the progress bar.
         * @param {boolean} isSuccess Temporary success mode for file upload feedback.
         */
        function showModal(message, showCloseButton = false, showProgress = false, isSuccess = false) {
            // Clear any previous timeouts
            if (successTimeout) clearTimeout(successTimeout);

            modalText.textContent = message;
            
            // Toggle success styling
            modalCard.classList.toggle('modal-success-card', isSuccess);
            modalCard.classList.toggle('card', !isSuccess); // Restore default card background

            const progressBarContainer = document.getElementById('progress-bar-container');
            if (showProgress) {
                progressBarContainer.classList.remove('hidden');
                startProgressSimulation();
            } else {
                progressBarContainer.classList.add('hidden');
                stopProgressSimulation();
            }
            
            if (showCloseButton) {
                modalCloseBtn.classList.remove('hidden');
            } else {
                modalCloseBtn.classList.add('hidden');
            }
            modalDiv.classList.remove('hidden');

            // Auto-hide success messages
            if (isSuccess) {
                successTimeout = setTimeout(hideModal, 1500); // 1.5 seconds for success message
            }
        }

        /**
         * Hides the custom modal.
         */
        function hideModal() {
            modalDiv.classList.add('hidden');
            stopProgressSimulation();
            if (successTimeout) {
                clearTimeout(successTimeout);
                successTimeout = null;
            }
        }

        // --- API Integration: Quiz Generation (Simplified) ---
        async function generateQuiz() {
            const themeInput = document.getElementById('theme-input');
            state.themeText = themeInput ? themeInput.value.trim() : '';

            // Combine theme text and file content.
            const fileContext = state.uploadedFiles
                .map(f => `--- Conte√∫do do Arquivo: ${f.name} ---\n${f.content}`)
                .join('\n\n');
                
            const context = fileContext + (state.themeText ? `\n\n--- Tema Principal ---\n${state.themeText}` : '');
            const num = state.numQuestions;

            if (!context || context.trim().length === 0) {
                showModal("Por favor, insira um tema ou carregue um arquivo.", true);
                return;
            }

            // System Instruction and User Query for Text Model
            const systemPrompt = `Voc√™ √© um gerador de quizzes inteligente e objetivo. Sua √∫nica fun√ß√£o √© analisar o tema ou conte√∫do fornecido e gerar uma lista de perguntas de m√∫ltipla escolha. Cada pergunta deve ter 4 op√ß√µes, e apenas uma deve ser correta. O n√∫mero total de perguntas deve ser exatamente ${num}. Sua resposta DEVE ser um objeto JSON estritamente conforme o esquema fornecido.`;
            const userQuery = `Gere ${num} perguntas de m√∫ltipla escolha com 4 op√ß√µes e o √≠ndice da resposta correta (de 0 a 3), baseado no seguinte tema ou conte√∫do:\n\n---\n\n${context}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        description: "Lista de perguntas do quiz.",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "question": { "type": "STRING", "description": "O texto da pergunta." },
                                "options": { "type": "ARRAY", "items": { "type": "STRING" }, "description": "Quatro op√ß√µes de resposta." },
                                "correctAnswerIndex": { "type": "NUMBER", "description": "O √≠ndice (0 a 3) da op√ß√£o correta na lista 'options'." }
                            },
                            required: ["question", "options", "correctAnswerIndex"]
                        }
                    }
                }
            };

            // START LOADING: Show progress bar modal (This remains here, as API generation is slow)
            showModal("Gerando perguntas...", false, true);

            try {
                const response = await withBackoff(3, () => fetch(textApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));

                // Adicionado: Verifica√ß√£o robusta de erros HTTP (4xx, 5xx)
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("Erro HTTP da API:", response.status, response.statusText, errorBody);
                    throw new Error(`Falha na comunica√ß√£o com a API (Status: ${response.status}). Verifique a chave de API.`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonString = candidate.content.parts[0].text;
                    const parsedJson = JSON.parse(jsonString);

                    if (Array.isArray(parsedJson) && parsedJson.length > 0) {
                        state.questions = parsedJson.slice(0, num); // Safety slice
                        
                        updateProgressBar(100);
                        setTimeout(() => {
                            hideModal(); // Ensure modal is removed after successful generation
                            state.view = 'options';
                            render();
                        }, 300); 
                    } else {
                        // Enhanced debugging for invalid JSON structure (if API returned 200 but bad data)
                        console.error("Resposta da API (JSON Inv√°lido ou Vazio):", parsedJson);
                        throw new Error("A API retornou uma estrutura de dados inv√°lida ou vazia.");
                    }
                } else {
                    // Enhanced debugging for missing candidate content
                    console.error("Resposta Completa da API (Candidato ausente):", result);
                    
                    // Verifica se h√° feedback de erro dos filtros de seguran√ßa
                    let errorMessage = "Falha ao receber conte√∫do da API.";
                    if (result.promptFeedback?.safetyRatings?.length > 0) {
                        errorMessage = "O conte√∫do gerado foi bloqueado pelos filtros de seguran√ßa. Tente mudar o tema.";
                    }
                    throw new Error(errorMessage);
                }

            } catch (error) {
                console.error("Erro na gera√ß√£o do Quiz:", error);
                hideModal(); // Make sure to hide the modal on error
                // Usa a mensagem de erro espec√≠fica capturada
                showModal(`Erro ao gerar perguntas. Tente novamente ou verifique a chave de API. (${error.message})`, true);
            }
        }

        // --- File Handling ---
        /**
         * Reads the content of uploaded files and updates the state.
         * REVISADA: Estrutura refor√ßada para garantir leitura e feedback visual correto.
         */
        function handleFileChange(event) {
            const files = event.target.files;
            if (files.length === 0) {
                event.target.value = ''; // Limpa se nada for selecionado
                return;
            }

            // Armazenamento tempor√°rio, o estado s√≥ √© atualizado ap√≥s todos os arquivos serem lidos
            const newFiles = [];
            let pendingReads = files.length;
            let readErrors = 0;
            
            // Limpa arquivos anteriores do estado e for√ßa uma re-renderiza√ß√£o para limpar as tags antigas
            state.uploadedFiles = [];
            renderInputScreen(); 

            /**
             * Fun√ß√£o que finaliza a leitura de um arquivo e verifica se todos terminaram.
             */
            const completeRead = () => {
                pendingReads--;
                if (pendingReads === 0) {
                    // 1. Atualiza o estado com os arquivos lidos com sucesso
                    state.uploadedFiles = newFiles; 
                    
                    // 2. Limpa o valor do input para permitir que o mesmo arquivo seja carregado novamente
                    event.target.value = ''; 
                    
                    // 3. Renderiza para mostrar a lista de arquivos atualizada (tags)
                    renderInputScreen(); 

                    // 4. Mostra o feedback apropriado
                    const readSuccess = newFiles.length;

                    if (readSuccess > 0 && readErrors === 0) {
                        // Todos lidos com sucesso
                        showModal(`Arquivo(s) adicionado(s) com sucesso! (${readSuccess} arquivo(s) lido(s))`, false, false, true);
                    } else if (readSuccess > 0 && readErrors > 0) {
                        // Alguns foram lidos, mas houve erros
                        showModal(`${readSuccess} arquivo(s) adicionado(s), mas ${readErrors} falhou(ram). Arquivos bin√°rios como PDF/PPT podem gerar texto ileg√≠vel.`, true);
                    } else if (readErrors > 0 && readSuccess === 0) {
                        // Todos falharam
                        showModal("A leitura de todos os arquivos falhou. Certifique-se de que s√£o arquivos de texto ou que o PDF/PPT n√£o est√° corrompido.", true);
                    }
                }
            };

            for (const file of files) {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    // Adiciona apenas arquivos que foram lidos com sucesso
                    newFiles.push({ name: file.name, content: e.target.result });
                    completeRead();
                };
                
                reader.onerror = () => {
                    readErrors++;
                    console.error(`Erro ao ler o arquivo ${file.name}.`);
                    completeRead();
                };
                
                // Tenta ler todos como texto simples
                reader.readAsText(file);
            }
        }

        /**
         * Removes a file from the uploaded list.
         * @param {number} index Index of the file to remove.
         */
        function removeFile(index) {
            if (index >= 0 && index < state.uploadedFiles.length) {
                state.uploadedFiles.splice(index, 1);
                renderInputScreen(); // Rerender to update the displayed list
            }
        }

        // --- Rendering Functions ---
        /**
         * Renders the initial input screen. (Image toggle removed)
         */
        function renderInputScreen() {
            const numQuestionsLabel = state.numQuestions === 1 ? 'pergunta' : 'perguntas';
            
            // Build the file display list
            const fileListHtml = state.uploadedFiles.map((file, index) => `
                <span class="file-tag">
                    <i data-lucide="file-text" class="w-3 h-3 mr-2"></i>
                    ${file.name}
                    <i data-lucide="x" class="file-tag-remove w-3 h-3" onclick="removeFile(${index})"></i>
                </span>
            `).join('');

            contentDiv.innerHTML = `
                <div class="card p-6 md:p-8 space-y-6">
                    <div>
                        <label for="theme-input" class="block text-text-secondary mb-2 text-sm">Insira o tema</label>
                        <div class="flex space-x-2">
                            <input type="text" id="theme-input" value="${state.themeText}" placeholder="Ex: A Hist√≥ria do JavaScript"
                                   class="input-field flex-grow p-3 rounded-lg text-base">

                            <input type="file" id="file-upload-input" accept=".txt, .pdf, .ppt, .pptx" class="hidden" multiple onchange="handleFileChange(event)">
                            <button id="file-upload-btn" onclick="document.getElementById('file-upload-input').click()"
                                    class="btn-option p-3 rounded-lg bg-card text-accent border border-accent/50 flex-shrink-0"
                                    title="Carregar arquivos .txt, .pdf ou .ppt para contexto">
                                <i data-lucide="paperclip" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <div id="file-name" class="mt-3 text-xs flex flex-wrap min-h-[30px] items-center">
                            ${state.uploadedFiles.length > 0 ? fileListHtml : '<p class="text-text-secondary italic">Nenhum arquivo carregado. Use o campo ou o clipe para adicionar contexto.</p>'}
                            <p class="text-text-secondary mt-1 text-xs w-full">Arquivos complexos (PDF/PPT) podem gerar texto ileg√≠vel. Use .txt para melhor precis√£o.</p>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label for="num-questions" class="text-text-secondary text-sm">
                                Quantas perguntas deseja gerar?
                            </label>
                            <span id="num-display" class="font-bold text-lg text-accent">${state.numQuestions} ${numQuestionsLabel}</span>
                        </div>
                        <input type="range" id="num-questions" min="1" max="30" value="${state.numQuestions}"
                               class="w-full" oninput="updateNumQuestions(event)">
                    </div>
                    
                    <button id="generate-btn" class="btn-accent w-full py-3 rounded-[12px] font-bold text-lg shadow-lg shadow-accent/30"
                            onclick="handleGenerateClick()">
                        Gerar
                    </button>
                </div>
            `;
            lucide.createIcons(); // Initialize Lucide icons
        }

        /**
         * Renders the screen with options to start the quiz or view all questions.
         */
        function renderOptionsScreen() {
            contentDiv.innerHTML = `
                <div class="card p-8 text-center space-y-6">
                    <h2 class="text-2xl font-bold">Quiz Gerado!</h2>
                    <p class="text-text-secondary">Seu quiz de ${state.questions.length} perguntas est√° pronto.</p>

                    <button class="btn-accent w-full py-4 rounded-[12px] font-bold text-lg shadow-lg shadow-accent/30"
                            onclick="startQuiz()">
                        Iniciar Quiz
                    </button>

                    <button class="btn-option w-full py-3 rounded-[12px] font-semibold bg-card text-accent border border-accent/50 hover:bg-accent/20"
                            onclick="viewReview()">
                        Ver todas as perguntas
                    </button>
                </div>
                <div class="mt-6 text-center">
                    <button class="text-text-secondary hover:text-accent text-sm" onclick="resetState()">
                        <i data-lucide="arrow-left" class="inline w-4 h-4 mr-1"></i> Voltar
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        /**
         * Renders the main quiz game interface. (Image display removed)
         */
        function renderQuizScreen() {
            if (state.currentQuestionIndex >= state.questions.length) {
                renderEndScreen();
                return;
            }

            const current = state.questions[state.currentQuestionIndex];
            const qNum = state.currentQuestionIndex + 1;
            const totalNum = state.questions.length;

            document.getElementById('current-score').classList.remove('hidden');
            document.getElementById('current-score').innerHTML = `Pontua√ß√£o: <span class="text-accent font-bold">${state.score}</span> | Pergunta: <span class="text-accent font-bold">${qNum}/${totalNum}</span>`;

            contentDiv.innerHTML = `
                <div class="card p-6 md:p-8 space-y-6">
                    <p class="text-lg font-semibold mb-4">${qNum}. ${current.question}</p>
                    <div class="space-y-3" id="options-container">
                        ${current.options.map((option, index) => `
                            <button class="btn-option w-full text-left p-4 rounded-lg text-base"
                                    onclick="handleAnswer(${index})" id="option-${index}">
                                ${String.fromCharCode(65 + index)}. ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <button class="text-text-secondary hover:text-error text-sm" onclick="resetState()">
                        <i data-lucide="x-circle" class="inline w-4 h-4 mr-1"></i> Sair do Quiz
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        /**
         * Renders the quiz results/end screen.
         */
        function renderEndScreen() {
            document.getElementById('current-score').classList.add('hidden');
            const total = state.questions.length;
            const score = state.score;
            const percentage = ((score / total) * 100).toFixed(0);
            
            // Set view explicitly to 'end' so 'backToLastScreen' knows where to go.
            state.view = 'end'; 

            contentDiv.innerHTML = `
                <div class="card p-8 text-center space-y-6">
                    <h2 class="text-3xl font-bold text-accent">Quiz Conclu√≠do!</h2>
                    <div class="space-y-2">
                        <p class="text-xl font-semibold">Sua Pontua√ß√£o Final:</p>
                        <p class="text-5xl font-extrabold text-success">${score} / ${total}</p>
                        <p class="text-lg text-text-secondary">Aproveitamento: ${percentage}%</p>
                    </div>

                    <div class="space-y-3 mt-6">
                        <button class="btn-accent w-full py-3 rounded-[12px] font-bold text-lg"
                                onclick="startQuizAgain()">
                            <i data-lucide="rotate-ccw" class="inline w-4 h-4 mr-2"></i> Jogar Novamente
                        </button>

                        <button class="btn-option w-full py-3 rounded-[12px] font-semibold text-accent"
                                onclick="viewReview()">
                            <i data-lucide="list-checks" class="inline w-4 h-4 mr-2"></i> Ver Perguntas
                        </button>
                                                
                        <button class="btn-option w-full py-3 rounded-[12px] font-semibold text-text-primary border-gray-700 hover:bg-gray-800"
                                onclick="resetState()">
                            <i data-lucide="home" class="inline w-4 h-4 mr-2"></i> Voltar ao Menu Principal
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        /**
         * Toggles the visibility of correct answers in review mode.
         */
        function toggleReviewAnswers() {
            state.showReviewAnswers = !state.showReviewAnswers;
            renderReviewScreen();
        }
        
        /**
         * Switches the view back to the previously active screen.
         */
        function backToPreviousScreen() {
            state.view = state.previousView;
            render();
        }

        /**
         * Renders the review screen with all questions.
         */
        function renderReviewScreen() {
            document.getElementById('current-score').classList.add('hidden');
            const buttonText = state.showReviewAnswers ? 'Esconder Respostas' : 'Mostrar Respostas';
            const iconName = state.showReviewAnswers ? 'eye-off' : 'eye';

            // L√≥gica para o bot√£o "Voltar"
            const backButtonText = state.previousView === 'end' ? 'Voltar ao Resultado' : 'Voltar √†s Op√ß√µes';
            const backButtonIcon = 'arrow-left';


            contentDiv.innerHTML = `
                <div class="text-center mb-6 space-y-4">
                    <h2 class="text-2xl font-bold">Revis√£o das Perguntas</h2>
                    <button class="btn-option py-2 px-4 rounded-lg font-semibold text-text-primary border border-accent/50 hover:bg-accent/20"
                            onclick="toggleReviewAnswers()">
                        <i data-lucide="${iconName}" class="inline w-4 h-4 mr-2"></i> ${buttonText}
                    </button>
                </div>
                <div class="space-y-6">
                    ${state.questions.map((q, qIndex) => `
                        <div class="card p-5 space-y-3">
                            <p class="text-lg font-semibold">${qIndex + 1}. ${q.question}</p>
                            <div class="space-y-2">
                                ${q.options.map((option, oIndex) => {
                                    const isCorrect = oIndex === q.correctAnswerIndex;
                                    
                                    let style = 'bg-card border-gray-700 text-text-primary';
                                    let icon = '';

                                    if (state.showReviewAnswers && isCorrect) {
                                        style = 'bg-success/20 border-success text-success font-bold';
                                        icon = '<i data-lucide="check-circle" class="inline w-4 h-4 ml-2 align-text-bottom"></i>';
                                    }

                                    return `
                                        <div class="p-3 rounded-lg border ${style} transition-colors duration-300">
                                            ${String.fromCharCode(65 + oIndex)}. ${option} ${icon}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-6 space-y-3">
                     <button class="btn-option w-full py-3 rounded-[12px] font-semibold text-text-primary border-gray-700 hover:bg-gray-800" onclick="backToPreviousScreen()">
                         <i data-lucide="${backButtonIcon}" class="inline w-4 h-4 mr-2"></i> ${backButtonText}
                     </button>
                    <div class="text-center">
                        <button class="text-text-secondary hover:text-accent text-sm" onclick="resetState()">
                            <i data-lucide="home" class="inline w-4 h-4 mr-1"></i> Voltar ao Menu Principal
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // --- Event Handlers & Logic ---
        /**
         * Updates the number of questions state from the slider.
         */
        function updateNumQuestions(event) {
            state.numQuestions = parseInt(event.target.value);
            const numQuestionsLabel = state.numQuestions === 1 ? 'pergunta' : 'perguntas';
            document.getElementById('num-display').textContent = `${state.numQuestions} ${numQuestionsLabel}`;
        }

        /**
         * Handles the main "Gerar" button click.
         */
        function handleGenerateClick() {
            const themeInput = document.getElementById('theme-input');
            state.themeText = themeInput ? themeInput.value.trim() : '';
            
            // Context is valid if theme text is present OR if files were loaded
            const contextValid = state.themeText.length > 0 || state.uploadedFiles.length > 0;

            if (!contextValid) {
                showModal("Por favor, insira um tema ou carregue um arquivo para gerar o quiz.", true);
                return;
            }
            generateQuiz();
        }

        /**
         * Initializes quiz state and switches to quiz view.
         */
        function startQuiz() {
            state.view = 'quiz';
            state.currentQuestionIndex = 0;
            state.score = 0;
            state.quizModeActive = true;
            render();
        }

        /**
         * Restarts the quiz using the already generated questions.
         */
        function startQuizAgain() {
            state.view = 'quiz';
            state.currentQuestionIndex = 0;
            state.score = 0;
            state.quizModeActive = true;
            render();
        }

        /**
         * Switches to review view and resets answer visibility.
         */
        function viewReview() {
            state.previousView = state.view; // Salva de onde viemos ('options' ou 'end')
            state.view = 'review';
            state.quizModeActive = false;
            state.showReviewAnswers = false; // Start with answers hidden
            render();
        }

        /**
         * Handles the user selecting an answer in quiz mode.
         */
        function handleAnswer(selectedIndex) {
            if (!state.quizModeActive) return;

            const current = state.questions[state.currentQuestionIndex];
            const isCorrect = selectedIndex === current.correctAnswerIndex;
            const optionsContainer = document.getElementById('options-container');

            // Disable all buttons to prevent double-clicking
            Array.from(optionsContainer.children).forEach(btn => btn.disabled = true);

            // Highlight chosen and correct answer
            const selectedBtn = document.getElementById(`option-${selectedIndex}`);
            const correctBtn = document.getElementById(`option-${current.correctAnswerIndex}`);

            if (isCorrect) {
                state.score++;
                selectedBtn.classList.replace('border-gray-700', 'border-success');
                selectedBtn.classList.add('bg-success/50', 'text-white', 'font-bold');
            } else {
                selectedBtn.classList.replace('border-gray-700', 'border-error');
                selectedBtn.classList.add('bg-error/50', 'text-white', 'font-bold');
                // Also highlight the correct one
                correctBtn.classList.replace('border-gray-700', 'border-success');
                correctBtn.classList.add('bg-success/20', 'text-success', 'font-bold');
            }

            // Update score display immediately
            document.getElementById('current-score').innerHTML = `Pontua√ß√£o: <span class="text-accent font-bold">${state.score}</span> | Pergunta: <span class="text-accent font-bold">${state.currentQuestionIndex + 1}/${state.questions.length}</span>`;

            // Move to next question after a brief delay
            setTimeout(() => {
                state.currentQuestionIndex++;
                render();
            }, 1200);
        }

        /**
         * Resets the application state to the initial input screen.
         */
        function resetState() {
            // Resets all state variables
            state.view = 'input';
            state.uploadedFiles = [];
            state.themeText = '';
            state.questions = [];
            state.currentQuestionIndex = 0;
            state.score = 0;
            state.quizModeActive = false;
            state.showReviewAnswers = false;
            document.getElementById('current-score').classList.add('hidden');
            render();
        }

        /**
         * Main render function based on the current state view.
         */
        function render() {
            switch (state.view) {
                case 'input':
                    renderInputScreen();
                    break;
                case 'options':
                    renderOptionsScreen();
                    break;
                case 'quiz':
                    renderQuizScreen();
                    break;
                case 'review':
                    renderReviewScreen();
                    break;
                case 'end':
                    renderEndScreen();
                    break;
                default:
                    renderInputScreen();
            }
        }

        // Initial render call
        window.onload = render;
    </script>
</body>
</html>

